<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="Content-Type" content="text/html" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Icon start -->
        <link rel="icon" href="../images/icons/IconSheet.svg#browserlogo">
        <link rel="apple-touch-icon" href="../images/icons/IconSheet.svg#browserlogo">
        <link rel="shortcut icon" href="../images/icons/IconSheet.svg#browserlogo" />
        <link rel="mask-icon" href="../images/icons/IconSheet.svg#browserlogo" />
        <!-- Icon end -->
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script defer src="https://www.googletagmanager.com/gtag/js?id=G-2W1VXE5GSE"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-2W1VXE5GSE');
        </script>
        <!-- Google Analytics TAG END  ---------------------->
        <!-- NO JS Behavior START -->
        <noscript>
            <style>
                nav.sidenav {display:none;}
                li.nav-item{display:none;}
            </style>
        </noscript>
         <!-- NO JS Behavior END -->

        <title>Jason Yang - PySpark Structured Streaming</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>

    <body>
        <!-- Side navigation start -->
        <nav class="sidenav">
            <li class="logo">
                <a href="#" class="nav-link">
                    <span class="link-text logo-text">Jason</span>
                    <svg><use href="../images/icons/IconSheet.svg#sidebardod"></use></svg>
                </a>
            </li>
        
            
            <li class="nav-item">
                <a href="../tags/mathcs.html" class="nav-link">
                    <svg><use href="../images/icons/IconSheet.svg#lambda"></use></svg>
                    <span class="link-text">Math/CS</span>
                </a>
            </li>
                
            <li class="nav-item">
                <a href="../tags/prog.html" class="nav-link">
                    <svg><use href="../images/icons/IconSheet.svg#progcode"></use></svg>
                    <span class="link-text">Prog</span>
                </a>
            </li>


            <li class="nav-item">
                <a href="../tags/AI.html" class="nav-link">
                    <svg><use href="../images/icons/IconSheet.svg#AIbrain"></use></svg>
                    <span class="link-text">ML/AI</span>
                </a>
            </li>

            <li class="nav-item">
                <a href="../tags/tech.html" class="nav-link">
                    <svg><use href="../images/icons/IconSheet.svg#hardware"></use></svg>
                    <span class="link-text">Tech</span>
                </a>
            </li>

            <li class="nav-item">
                <a href="../tags/musings.html" class="nav-link">
                    <svg><use href="../images/icons/IconSheet.svg#thinker"></use></svg>
                    <span class="link-text">Musings</span>
                </a>
            </li>


            <li class="nav-item">
                <a href="#" class="nav-link">
                    <svg><use href="../images/icons/IconSheet.svg#react"></use></svg>
                    <span class="link-text">React</span>
                </a>
            </li>
        </nav>
        <!-- Side navigation end -->
        <div id="header">
            <div id="logo">
                <a href="../">Jason Yang</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>PySpark Structured Streaming</h1>
            

            <div class="info">
    Posted on March 23, 2021
    
</div>
<div class="info">
    
    Tags: <a title="All pages tagged 'python'." href="../tags/python.html">python</a>, <a title="All pages tagged 'AI'." href="../tags/AI.html">AI</a>
    
</div>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>NAME <span class="op">=</span> <span class="st">&quot;UserJY&quot;</span></span></code></pre></div>
<hr />
<p>Jupyter notebook:</p>
<p><img src="jupyter.png" /></p>
<section id="structured-streaming" class="level2" data-number="0.1">
<h2 data-number="0.1"><span class="header-section-number">0.1</span> Structured Streaming</h2>
<p>structured streaming to analyze made-up trail camera data. We will simulate real-time streaming by having multiple data files and loading them one by one.</p>
<p>https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession, Row</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyspark.sql</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.types <span class="im">import</span> <span class="op">*</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, clear_output</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>spark <span class="op">=</span> SparkSession <span class="op">\</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    .builder <span class="op">\</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    .appName(<span class="st">&quot;StructuredStreaming&quot;</span>) <span class="op">\</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    .getOrCreate()</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">&quot;data/&quot;</span></span></code></pre></div>
</section>
<section id="load-data" class="level2" data-number="0.2">
<h2 data-number="0.2"><span class="header-section-number">0.2</span> Load data</h2>
<p>First we’ll start with normal dataframe exercises. Create a method that loads the trail camera data into a dataframe. The data is in JSON format. You might have to specify the schema with the StructType methods. The dataframe will have null values called ‘null’, you can either remove them or leave them be. This dataframe simulates the input dataframe that we will use for streaming.</p>
<p>param <code>path</code>: path to the JSON dataset.</p>
<p><code>return</code>: dataframe containing trail camera information.</p>
<p>schema:</p>
<table>
<thead>
<tr class="header">
<th>Name</th>
<th style="text-align: left;">Type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time</td>
<td style="text-align: left;">Timestamp (nullable = true)</td>
</tr>
<tr class="even">
<td>animal_name</td>
<td style="text-align: left;">String (nullable = true)</td>
</tr>
<tr class="odd">
<td>weather</td>
<td style="text-align: left;">String (nullable = true)</td>
</tr>
<tr class="even">
<td>battery</td>
<td style="text-align: left;">Double (nullable = true)</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataFrame representing data in the JSON files</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loadData(path):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">#path = &quot;testdata/&quot;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    jsonSchema <span class="op">=</span> (StructType()</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                 .add(<span class="st">&quot;time&quot;</span>,TimestampType())</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                 .add(<span class="st">&quot;animal_name&quot;</span>,StringType())</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                 .add(<span class="st">&quot;weather&quot;</span>,StringType())</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                 .add(<span class="st">&quot;battery&quot;</span>,DoubleType())</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    outdf <span class="op">=</span> spark.read.json(path, schema <span class="op">=</span> jsonSchema).dropna(<span class="st">&quot;any&quot;</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> outdf</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#example print</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>loadData(path).show()</span></code></pre></div>
<pre><code>+-------------------+-----------+-------+-------+
|               time|animal_name|weather|battery|
+-------------------+-----------+-------+-------+
|2020-04-18 21:50:40|       Deer|  Clear|    7.0|
|2020-03-10 11:23:34|   Squirrel|  Clear|   86.0|
|2019-11-09 20:36:04|   Squirrel|  Clear|   55.0|
|2019-10-31 07:22:20|   Squirrel| Cloudy|   12.0|
|2020-05-04 10:59:35|   Squirrel|  Clear|   64.0|
|2020-01-30 14:21:35|   Squirrel|  Clear|   34.0|
|2019-10-29 19:20:05|     Rabbit|  Rainy|    6.0|
|2020-01-30 11:34:51|   Squirrel|  Rainy|   96.0|
|2020-07-17 19:32:23|       Deer| Cloudy|   17.0|
|2020-05-27 09:42:41|   Squirrel|  Rainy|    5.0|
|2020-05-28 09:00:05|       Bear|  Storm|   53.0|
|2020-08-07 11:02:38|       Deer| Cloudy|   14.0|
|2019-06-22 16:02:52|     Rabbit|  Clear|   13.0|
|2019-09-23 11:56:31|   Squirrel|  Clear|   95.0|
|2020-05-31 07:27:03|   Squirrel|  Clear|  100.0|
|2019-11-29 19:11:53|     Rabbit|  Clear|   71.0|
|2020-03-23 20:06:24|     Rabbit|  Clear|   19.0|
|2019-07-12 10:45:52|   Squirrel|  Rainy|   15.0|
|2020-05-30 13:07:53|     Rabbit|  Rainy|   84.0|
|2019-06-09 04:34:10|     Rabbit|  Clear|   95.0|
+-------------------+-----------+-------+-------+
only showing top 20 rows</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">'''loadData tests'''</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> StructType([ StructField(<span class="st">&quot;time&quot;</span>, TimestampType(), <span class="va">True</span>),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                    StructField(<span class="st">&quot;animal_name&quot;</span>, StringType(), <span class="va">True</span>),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                    StructField(<span class="st">&quot;weather&quot;</span>, StringType(), <span class="va">True</span>),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                    StructField(<span class="st">&quot;battery&quot;</span>, DoubleType(), <span class="va">True</span>)])</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>testTs <span class="op">=</span> datetime(<span class="dv">2020</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>fakeData <span class="op">=</span> [(testTs, <span class="st">&quot;dog&quot;</span>, <span class="st">&quot;cloudy&quot;</span>, <span class="fl">100.0</span>)]</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>fakeDf <span class="op">=</span> spark.createDataFrame(fakeData, cols)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> loadData(path)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df.dtypes <span class="op">==</span> fakeDf.dtypes, <span class="st">&quot;the schema was expected to be </span><span class="sc">%s</span><span class="st"> but it was </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span> (fakeDf.dtypes, df.dtypes)</span></code></pre></div>
</section>
<section id="animal-count" class="level2" data-number="0.3">
<h2 data-number="0.3"><span class="header-section-number">0.3</span> Animal count</h2>
<p>Next we will simulate the output dataframe that we will use for streaming. Create a method that counts the number of appearences for each animal. The dataframe should be sorted by count in descending order. You should remove the null rows now if you didn’t do it in the last method.</p>
<p>param <code>df</code>: trail camera dataframe created using <code>loadData</code>.</p>
<p><code>return</code>: dataframe containing number of appearences per animal. The dataframe should include columns “animal_name” and “count”. “count” should be in Long format, it should happen automatically with spark functions. The dataframe must not include count for null values.</p>
<p>example output:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">animal_name</th>
<th>count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">Dog</td>
<td>1234</td>
</tr>
<tr class="even">
<td style="text-align: right;">Cat</td>
<td>1111</td>
</tr>
<tr class="odd">
<td style="text-align: right;">Mouse</td>
<td>999</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> animalCount(df):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    df.createOrReplaceTempView(<span class="st">&quot;ntable&quot;</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    newdf <span class="op">=</span> spark.sql(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT animal_name, COUNT(animal_name) AS count FROM ntable</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="st">        GROUP BY animal_name</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="st">        ORDER BY count DESC</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> newdf</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># YOUR CODE HERE</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#raise NotImplementedError()</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#example print</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>animalCount(loadData(path)).show()</span></code></pre></div>
<pre><code>+-----------+-----+
|animal_name|count|
+-----------+-----+
|     Rabbit| 1187|
|   Squirrel| 1147|
|       Deer|  351|
|       Bear|  119|
|       Wolf|  111|
+-----------+-----+</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">'''animalCount tests'''</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> StructType([ StructField(<span class="st">&quot;animal_name&quot;</span>, StringType(), <span class="va">True</span>),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                    StructField(<span class="st">&quot;count&quot;</span>, LongType(), <span class="va">False</span>)])</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>fakeData <span class="op">=</span> [(<span class="st">&quot;dog&quot;</span>, <span class="dv">1</span>)]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>fakeDf <span class="op">=</span> spark.createDataFrame(fakeData, cols)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> animalCount(loadData(path))</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df.dtypes <span class="op">==</span> fakeDf.dtypes, <span class="st">&quot;the schema was expected to be </span><span class="sc">%s</span><span class="st"> but it was </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span> (fakeDf.dtypes, df.dtypes)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df.count() <span class="op">==</span> <span class="dv">5</span>, <span class="st">&quot;the number of rows was expected to be 5 but it was </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span> df.count()</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.toPandas()</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df.loc[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">&gt;=</span> df.loc[<span class="dv">1</span>][<span class="dv">1</span>], <span class="st">&quot;the first item was expected to have higher count than the second&quot;</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df.loc[<span class="dv">3</span>][<span class="dv">1</span>] <span class="op">&gt;=</span> df.loc[<span class="dv">4</span>][<span class="dv">1</span>], <span class="st">&quot;the fourth item was expected to have higher count than the last&quot;</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df.loc[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">==</span> <span class="st">&quot;Rabbit&quot;</span>, <span class="st">&quot;the first item was expected to be Rabbit but it was </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span> df.loc[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df.loc[<span class="dv">4</span>][<span class="dv">0</span>] <span class="op">==</span> <span class="st">&quot;Wolf&quot;</span>, <span class="st">&quot;the last item was expected to be Wolf but it was </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span> df.loc[<span class="dv">4</span>][<span class="dv">0</span>]</span></code></pre></div>
</section>
<section id="inputdf" class="level2" data-number="0.4">
<h2 data-number="0.4"><span class="header-section-number">0.4</span> inputDf</h2>
<p>Now we will finally do the streaming. First you should specify the schema for the input dataframe. The schema is the same as in the Load Data exercise. Then you should create the input dataframe with <code>spark.readStream</code> method. Remember to include the schema and the path. You will also have to include <code>.option("maxFilesPerTrigger", 1)</code> so that we can simulate real-time streaming by loading one file at a time.</p>
<p>param <code>path</code>: path to the JSON dataset.</p>
<p><code>return</code>: input dataframe containing trail camera information.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inputDf(path):  </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    jsonSchema <span class="op">=</span> (StructType()</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                 .add(<span class="st">&quot;time&quot;</span>,TimestampType())</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                 .add(<span class="st">&quot;animal_name&quot;</span>,StringType())</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                 .add(<span class="st">&quot;weather&quot;</span>,StringType())</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                 .add(<span class="st">&quot;battery&quot;</span>,DoubleType())</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    inputDF <span class="op">=</span> (spark</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>               .readStream </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>               .schema(jsonSchema)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>               .option(<span class="st">&quot;maxFilesPerTrigger&quot;</span>,<span class="dv">1</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>               .json(path)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>               .dropna(<span class="st">&quot;any&quot;</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># YOUR CODE HERE</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> inputDF</span></code></pre></div>
</section>
<section id="outputdf" class="level2" data-number="0.5">
<h2 data-number="0.5"><span class="header-section-number">0.5</span> outputDf</h2>
<p>Next you should create the output dataframe, similar to the Animal Count exercise. You will have to exclude the null values and sort the dataframe by count, descending order.</p>
<p>param <code>inputDF</code>: input dataframe created by <code>inputDf()</code>.</p>
<p><code>return</code>: filtered and sorted dataframe containing the number of appearences per animal.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> outputDf(inputDF):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    filterDF <span class="op">=</span> inputDF.createOrReplaceTempView(<span class="st">&quot;streamTable&quot;</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    newdf <span class="op">=</span> spark.sql(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT animal_name, COUNT(animal_name) AS count </span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM streamTable</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="st">        GROUP BY animal_name</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="st">        ORDER BY count DESC</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> newdf</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># YOUR CODE HERE</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">#raise NotImplementedError()</span></span></code></pre></div>
</section>
<section id="createquery" class="level2" data-number="0.6">
<h2 data-number="0.6"><span class="header-section-number">0.6</span> createQuery</h2>
<p>Finally, you should start streaming the output dataframe with the <code>writeStream</code> method. You will have to include the options <code>format</code>=“memory”, <code>queryName</code>=“counts” and <code>outputMode</code>=“complete”.</p>
<p>param <code>outputDF</code>: output dataframe created by <code>outputDf()</code>.</p>
<p><code>return</code>: a query on the output dataframe</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> createQuery(outputDF):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> (outputDF</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>             .writeStream </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>             .<span class="bu">format</span>(<span class="st">&quot;memory&quot;</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>             .outputMode(<span class="st">&quot;complete&quot;</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>             .queryName(<span class="st">&quot;counts&quot;</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>             .start()</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># YOUR CODE HERE</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="fl">0.5</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> query</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">'''streaming tests'''</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>inputStreamDf <span class="op">=</span> inputDf(path)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>outputStreamDf<span class="op">=</span> outputDf(inputStreamDf)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> createQuery(outputStreamDf)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> outputStreamDf.isStreaming, <span class="st">&quot;the outputDF was expected to be streaming&quot;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> spark.sql(<span class="st">&quot;select * from counts&quot;</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df.dtypes <span class="op">==</span> fakeDf.dtypes, <span class="st">&quot;the schema was expected to be </span><span class="sc">%s</span><span class="st"> but it was </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span> (fakeDf.dtypes, df.dtypes)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>status <span class="op">=</span> {<span class="st">'message'</span>: <span class="st">'Processing new data'</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a> <span class="st">'isDataAvailable'</span>: <span class="va">True</span>,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a> <span class="st">'isTriggerActive'</span>: <span class="va">True</span>}</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> query.status <span class="op">==</span> status, <span class="st">&quot;the status was expected to be </span><span class="sc">%s</span><span class="st"> but it was </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span> (status, query.status)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df.count() <span class="op">==</span> <span class="dv">0</span>, <span class="st">&quot;the number of rows was expected to be 0 when the streaming just started but it was </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span> df.count()</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>time.sleep(<span class="dv">20</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df.count() <span class="op">==</span> <span class="dv">5</span>, <span class="st">&quot;the number of rows was expected to be 5 when the streaming has been going for a while but it was </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span> df.count()</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.toPandas()</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df.loc[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">&gt;=</span> df.loc[<span class="dv">1</span>][<span class="dv">1</span>], <span class="st">&quot;the first item was expected to have higher count than the second&quot;</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df.loc[<span class="dv">3</span>][<span class="dv">1</span>] <span class="op">&gt;=</span> df.loc[<span class="dv">4</span>][<span class="dv">1</span>], <span class="st">&quot;the fourth item was expected to have higher count than the last&quot;</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df.loc[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">==</span> <span class="st">&quot;Rabbit&quot;</span> <span class="kw">or</span> df.loc[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">==</span> <span class="st">&quot;Squirrel&quot;</span>, <span class="st">&quot;the first item was expected to be Rabbit or Squirrel but it was </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span> df.loc[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df.loc[<span class="dv">4</span>][<span class="dv">0</span>] <span class="op">==</span> <span class="st">&quot;Wolf&quot;</span> <span class="kw">or</span> df.loc[<span class="dv">4</span>][<span class="dv">0</span>] <span class="op">==</span> <span class="st">&quot;Bear&quot;</span>, <span class="st">&quot;the last item was expected to be Wolf or Bear but it was </span><span class="sc">%s</span><span class="st">&quot;</span> <span class="op">%</span> df.loc[<span class="dv">4</span>][<span class="dv">0</span>]</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stream printing in real-time</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># you can increase the total streaming simulation duration by increasing &quot;nIter&quot;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># However, when finally submitting the assignment make sure to change &quot;nIter&quot; back to a smaller value. </span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>nIter <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(nIter):</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    clear_output(wait<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    display(query.status)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    display()</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">3</span>)</span></code></pre></div>
<pre><code>{'message': 'Processing new data',
 'isDataAvailable': True,
 'isTriggerActive': True}</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>spark.stop()</span></code></pre></div>
</section>

        </div>
        <div id="footer">
            <div class="flex-container" style="display:flex; justify-content: space-between;">
                <div>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
                </div>
   
            <div xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"><a property="dct:title" rel="cc:attributionURL" href="https://userjy.github.io/">Jason's Notes</a> by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="https://userjy.github.io/">Jason Yang</a> is licensed under <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY-NC-ND 4.0<img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1"><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nd.svg?ref=chooser-v1"></a></div>
  
            </div>
        </div>
        
    </body>
    <footer>
        <!-- CODE TAB START -->
        <script>
                    //Structure:
                    // Codeblock < Group/Grouplabel/subgrp < datagroupSet < allblocks

            const AllBlocksPre = document.querySelectorAll("[data-group]");
            const AllBlocks = [...AllBlocksPre]; //gets all codeblocks w/ and w/o group label
            const getUniqueSet = (TargetSet,dataAttr) => {
                //gets the set of attributes of an array of codeblocks aka TargetSet
                const temp = TargetSet.map((e) => (e.getAttribute(dataAttr))); 
                const temp2 = temp.filter((a)=>a); //remove nulls
                return [...new Set(temp2)];
            } 
            const datagroupSet = getUniqueSet(AllBlocks,"data-group") //remove nulls

            const getCodeBlocks = (datagroup) => {
                //return list of glabels CodeBlocks associated to a single group 
                return AllBlocks.filter((dataglabelBlock)=>(dataglabelBlock.getAttribute("data-group") === datagroup));
            }

            const showBlocks = (dataglabeltxt,datagroupCodeBlocks) => {
                const selectedglabelGroup = datagroupCodeBlocks.filter((SingleBlock)=>(SingleBlock.getAttribute("data-glabel") === dataglabeltxt))
                const NONselectedglabelGroup = datagroupCodeBlocks.filter((SingleBlock)=>(SingleBlock.getAttribute("data-glabel") !== dataglabeltxt))
                selectedglabelGroup.map((SingleBlock) => (SingleBlock.style.display="block"));
                (NONselectedglabelGroup || []).map((SingleBlock) => (SingleBlock.style.display="none"));
            }
            const mkBtn = (dataglabeltxt,datagroupCodeBlocks,showfunc) => {
                const newbutton = document.createElement("button");
                newbutton.textContent = dataglabeltxt;
                newbutton.addEventListener('click', ()=>{
                    showfunc(dataglabeltxt,datagroupCodeBlocks);
                });
                return newbutton;
            }
            const showAll = (datagroup) => {
                //make all codeblocks visible
            datagroup.map((e)=>(e.style.display="block"));
            }

            const buildCodeTab = (datagroupCodeBlocks) => {
                const leader = datagroupCodeBlocks[0]; //get the leader codeblock of a group of codeblock
                const setglabelstxt = getUniqueSet(datagroupCodeBlocks,"data-glabel"); 
                setglabelstxt.map((singleglabeltxt)=>{
                    const btn = mkBtn(singleglabeltxt,datagroupCodeBlocks,showBlocks)
                    leader.insertAdjacentElement("beforebegin",btn);

                })
                
                //make showAll button START
                const btnShowAll = document.createElement("button");
                btnShowAll.textContent = "All";
                btnShowAll.addEventListener('click',(e)=>(showAll(datagroupCodeBlocks)));
                leader.insertAdjacentElement('beforebegin', btnShowAll);
                //make showAllbutton END
            }

            //below code is performing actual behavior, the above code are just functions
            datagroupSet.map((datagroup) => {
                const groupOfCodeblocks = getCodeBlocks(datagroup);
                buildCodeTab(groupOfCodeblocks);
                const firsttab = groupOfCodeblocks[0]
                showBlocks(firsttab.getAttribute("data-glabel"),groupOfCodeblocks);
       
            })
        </script>
        <!-- CODE TAB END ---->

        <!-- MATH JAX START -------------------------------------- -->
        <script id="MathJax-script" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-chtml.min.js">
        </script>
        <!-- MATH JAX END ----------------------------------------- -->

        <!-- RAILROAD START -------------------------------------- -->
        <script type="module">
            import rr,* as rrClass from "/lib/railroad/railroad.js";
            Object.assign(window,rr)
            window.rrOptions = rrClass.Options;
            document.addEventListener('DOMContentLoaded',()=>{ReplaceDivWithSvg()},false)
            const ReplaceDivWithSvg = () =>  {
                for (const railroadelem of document.getElementsByClassName("rroad") ){
                railroadelem.innerHTML = eval(railroadelem.innerText.trim()+".toString()")
                }
            }
        </script>
        

        <link rel="stylesheet" href="../lib/railroad/railroad-diagrams.css">
        <!-- RAILROAD END ----------------------------------------- -->
    </footer>
</html>
